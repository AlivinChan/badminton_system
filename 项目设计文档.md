# 校园羽毛球馆场地预约管理系统 - 项目设计文档

## 1. 项目概述

### 1.1 项目简介
校园羽毛球馆场地预约管理系统是一个基于Java开发的桌面应用程序，旨在为校园羽毛球馆提供完整的场地预约管理解决方案。系统支持学生预约场地、管理员管理预约和场地信息，以及统计功能。

### 1.2 技术栈
- **开发语言**: Java 8+
- **UI框架**: Java Swing
- **数据存储**: JSON文件（自定义解析，无外部依赖）
- **架构模式**: MVC（Model-View-Controller）
- **设计模式**: 服务层模式、策略模式（费用计算）

### 1.3 核心特性
- 学生注册、登录、预约、取消预约
- 管理员登录、预约管理、场地管理、统计分析
- 实时冲突检测和时间段验证
- 支持中英文冒号时间输入（09:00 或 09：00）
- 整点时间验证（仅允许HH:00格式）
- 实时场地可用性高亮显示（冲突场地标红）
- 简约美观的现代化UI设计
- JSON文件持久化存储

## 2. 系统架构

### 2.1 整体架构
系统采用分层架构设计，分为以下层次：

```
┌─────────────────────────────────────┐
│          UI Layer (视图层)           │
│  ┌─────────────┐  ┌──────────────┐ │
│  │  Swing UI   │  │  Console UI  │ │
│  └─────────────┘  └──────────────┘ │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│       Service Layer (服务层)         │
│  UserService, BookingService, etc.  │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│    Persistence Layer (持久化层)      │
│            JsonDB                    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│        Model Layer (模型层)          │
│  Student, Admin, Court, Booking...  │
└─────────────────────────────────────┘
```

### 2.2 包结构
```
com.badminton
├── model/              # 数据模型
│   ├── Student.java           # 学生实体
│   ├── Admin.java             # 管理员实体
│   ├── Court.java             # 场地实体
│   ├── Booking.java           # 预约实体
│   ├── TimeSlot.java          # 时间段实体
│   ├── CourtType.java         # 场地类型枚举（单打/双打）
│   ├── CourtStatus.java       # 场地状态枚举（可用/维护中）
│   └── BookingState.java      # 预约状态枚举（待确认/已完成/已取消）
├── persistence/        # 数据持久化
│   ├── JsonDB.java            # JSON数据库实现
│   └── InMemoryDB.java        # 内存数据库（已废弃）
├── service/            # 业务服务层
│   ├── UserService.java       # 用户服务（学生注册、登录）
│   ├── AdminService.java      # 管理员服务（管理员登录）
│   ├── BookingService.java    # 预约服务（创建、取消、冲突检测）
│   ├── CourtService.java      # 场地服务（场地管理）
│   └── StatisticsService.java # 统计服务（评分、收入统计）
├── util/               # 工具类
│   ├── BusinessException.java # 业务异常
│   ├── FeePolicy.java         # 费用计算策略接口
│   └── DefaultFeePolicy.java  # 默认费用计算实现
└── ui/                 # 用户界面
    ├── console/        # 控制台界面
    │   └── ConsoleUI.java
    └── swing/          # Swing图形界面
        ├── MainFrame.java              # 主窗口
        ├── LoginPanel.java            # 登录面板
        ├── StudentDashboardPanel.java # 学生功能面板
        └── AdminDashboardPanel.java   # 管理员功能面板
```

## 3. 核心模块设计

### 3.1 数据模型层（Model Layer）

#### 3.1.1 Student（学生模型）
**文件位置**: `src/main/java/com/badminton/model/Student.java`

**属性**:
- `studentId`: String - 学号（唯一标识）
- `name`: String - 姓名
- `phone`: String - 手机号

**职责**: 封装学生基本信息

#### 3.1.2 Admin（管理员模型）
**文件位置**: `src/main/java/com/badminton/model/Admin.java`

**属性**:
- `adminId`: String - 工号（唯一标识）
- `name`: String - 姓名
- `phone`: String - 手机号
- `password`: String - 密码

**职责**: 封装管理员信息和认证凭据

#### 3.1.3 Court（场地模型）
**文件位置**: `src/main/java/com/badminton/model/Court.java`

**属性**:
- `courtId`: String - 场地编号（唯一标识，如C001）
- `type`: CourtType - 场地类型（SINGLES/DOUBLES）
- `status`: CourtStatus - 场地状态（AVAILABLE/MAINTENANCE）
- `baseScore`: double - 基础评分

**职责**: 封装场地信息和状态

#### 3.1.4 Booking（预约模型）
**文件位置**: `src/main/java/com/badminton/model/Booking.java`

**属性**:
- `bookingId`: String - 预约ID（唯一标识，格式：BKxxxxxxxx）
- `student`: Student - 预约学生
- `courtId`: String - 场地编号
- `slot`: TimeSlot - 预约时间段
- `state`: BookingState - 预约状态（PENDING/COMPLETED/CANCELLED）
- `fee`: double - 预约费用
- `rating`: int - 评分（0-5，0表示未评分）
- `createdAt`: LocalDateTime - 创建时间

**职责**: 封装预约信息和状态

#### 3.1.5 TimeSlot（时间段模型）
**文件位置**: `src/main/java/com/badminton/model/TimeSlot.java`

**属性**:
- `date`: LocalDate - 日期
- `start`: LocalTime - 开始时间
- `end`: LocalTime - 结束时间

**核心方法**:
- `overlaps(TimeSlot other)`: boolean - 检测时间段是否重叠

**职责**: 封装时间段信息，提供冲突检测功能

### 3.2 持久化层（Persistence Layer）

#### 3.2.1 JsonDB（JSON数据库）
**文件位置**: `src/main/java/com/badminton/persistence/JsonDB.java`

**设计特点**:
- 不依赖外部JSON库（如Gson），使用纯Java实现JSON解析和序列化
- 数据存储在 `data/` 目录下的JSON文件中：
  - `students.json` - 学生数据
  - `admins.json` - 管理员数据
  - `courts.json` - 场地数据
  - `bookings.json` - 预约数据

**核心方法**:
- `loadFromFile()`: JsonDB - 静态方法，从文件加载数据
- `saveToFile()`: void - 保存所有数据到文件
- `addStudent/Admin/Court/Booking()`: void - 添加数据
- `findStudent/Admin/Court/BookingById()`: T - 根据ID查找
- `generateBookingId()`: String - 生成唯一预约ID

**JSON解析策略**:
- 使用正则表达式提取字符串、数字字段
- 使用大括号匹配算法（`findMatchingBrace`）解析嵌套对象
- 手动处理 `LocalDate`、`LocalTime`、`LocalDateTime` 的序列化/反序列化

**关键代码位置**:
- 大括号匹配算法: 第474-484行
- JSON序列化: 第186-208行（`writeListToFile`）
- JSON解析: 第301-463行（`readStudentsFromFile`等）

### 3.3 服务层（Service Layer）

#### 3.3.1 UserService（用户服务）
**文件位置**: `src/main/java/com/badminton/service/UserService.java`

**职责**: 处理学生注册和登录

**核心方法**:
- `registerStudent(String studentId, String name, String phone)`: Student - 注册学生
- `loginStudent(String studentId)`: Student - 学生登录

**业务规则**:
- 学号必须唯一
- 手机号格式验证

#### 3.3.2 BookingService（预约服务）
**文件位置**: `src/main/java/com/badminton/service/BookingService.java`

**职责**: 处理预约相关业务逻辑

**核心方法**:
- `createBooking(String studentId, String courtId, TimeSlot slot)`: Booking - 创建预约
- `cancelBooking(String studentId, String bookingId)`: void - 取消预约
- `isConflict(String courtId, TimeSlot slot)`: boolean - 检测冲突
- `rateBooking(String studentId, String bookingId, int rating)`: void - 评分
- `getBookingsByStudent(String studentId)`: Booking[] - 获取学生预约列表

**业务规则**:
- 创建预约前检查场地是否存在、是否维护中
- 使用 `isConflict()` 检测时间段冲突（排除已取消的预约）
- 费用通过 `FeePolicy` 策略计算
- 取消预约需要验证权限和状态

**冲突检测逻辑**（第112-128行）:
```java
public boolean isConflict(String courtId, TimeSlot slot) {
    Booking[] bookings = db.getBookings();
    for (int i = 0; i < db.getBookingCount(); i++) {
        Booking booking = bookings[i];
        if (booking == null) continue;
        if (!booking.getCourtId().equals(courtId)) continue;
        if (booking.getState() == BookingState.CANCELLED) continue;
        if (booking.getSlot().overlaps(slot)) {
            return true;
        }
    }
    return false;
}
```

#### 3.3.3 CourtService（场地服务）
**文件位置**: `src/main/java/com/badminton/service/CourtService.java`

**职责**: 管理场地信息

**核心方法**:
- `getAllCourts()`: Court[] - 获取所有场地
- `updateCourtStatus(String courtId, CourtStatus status)`: void - 更新场地状态

#### 3.3.4 StatisticsService（统计服务）
**文件位置**: `src/main/java/com/badminton/service/StatisticsService.java`

**职责**: 提供统计分析功能

**核心方法**:
- `getCourtRatings()`: Map<String, Object> - 获取场地评分统计
- `getRevenueStats(LocalDate start, LocalDate end)`: Map<String, Object> - 获取收入统计

### 3.4 UI层（UI Layer）

#### 3.4.1 MainFrame（主窗口）
**文件位置**: `src/main/java/com/badminton/ui/swing/MainFrame.java`

**职责**: 应用程序主窗口，管理面板切换

**设计特点**:
- 使用 `CardLayout` 管理多个面板（登录、学生、管理员）
- 在 `main()` 方法中设置UI默认属性（第149-168行）
- 初始化服务层实例（第35-46行）
- 自动初始化默认数据（8个场地，1个管理员）（第48-83行）

**关键代码**:
- 服务初始化: 第35-46行
- UI初始化: 第85-111行
- 面板切换: 第135-147行

#### 3.4.2 LoginPanel（登录面板）
**文件位置**: `src/main/java/com/badminton/ui/swing/LoginPanel.java`

**职责**: 处理学生注册、学生登录、管理员登录

**设计特点**:
- 使用 `JTabbedPane` 组织三个标签页
- 自定义样式化组件：
  - `createStyledTextField()`: 圆角输入框，聚焦时蓝色边框（第35-64行）
  - `createStyledPasswordField()`: 样式化密码框（第66-95行）
  - `createStyledButton()`: 蓝色圆角按钮，白色文字（第69-120行）
- 按钮使用自定义 `paintComponent()` 绘制，不调用 `super.paintComponent()` 以避免系统UI覆盖

**关键代码**:
- 按钮自定义绘制: 第72-99行
- 学生登录逻辑: 第122-145行
- 学生注册逻辑: 第147-180行
- 管理员登录逻辑: 第182-205行

#### 3.4.3 StudentDashboardPanel（学生功能面板）
**文件位置**: `src/main/java/com/badminton/ui/swing/StudentDashboardPanel.java`

**职责**: 学生预约功能界面

**核心功能**:
1. **场地查询与显示**（`showAllCourts()` 方法，第425-490行）:
   - 实时显示所有场地信息
   - 使用自定义 `DefaultTableCellRenderer` 高亮冲突场地
   - 冲突场地：红色背景（255, 200, 200），深红色文字（180, 0, 0），状态显示"UNAVAILABLE"
   - 可用场地：淡蓝色背景（173, 216, 230），白色文字

2. **时间输入规范化**（`normalizeTimeString()` 方法，第43-46行）:
   - 支持中英文冒号（09:00 或 09：00）
   - 自动将中文冒号转换为英文冒号

3. **实时冲突检测**:
   - 使用 `DocumentListener` 监听输入框变化（第200-220行）
   - 输入变化时自动调用 `showAllCourts()` 更新表格显示

4. **预约创建**（`createBooking()` 方法，第492-570行）:
   - 验证时间格式为整点（HH:00）
   - 验证分钟必须为00
   - 调用 `BookingService.createBooking()` 创建预约
   - 成功后刷新表格

5. **我的预约列表**（`refreshMyBookings()` 方法，第572-610行）:
   - 过滤掉已取消的预约（`BookingState.CANCELLED`）
   - 显示预约详情和操作按钮

**关键代码位置**:
- 表格样式设置: 第68-101行（`setupTableStyle`）
- 冲突检测渲染器: 第445-475行（`showAllCourts`中的自定义渲染器）
- 时间规范化: 第43-46行
- 整点验证: 第512-524行

#### 3.4.4 AdminDashboardPanel（管理员功能面板）
**文件位置**: `src/main/java/com/badminton/ui/swing/AdminDashboardPanel.java`

**职责**: 管理员管理功能界面

**核心功能**:
1. **预约管理**: 查看所有预约（排除已取消），确认完成
2. **场地管理**: 查看所有场地，更改场地状态
3. **统计功能**: 场地评分统计、收入统计

**关键代码**:
- 预约列表刷新: `refreshBookings()` - 过滤已取消预约
- 表格样式: 使用 `setupTableStyle()` 统一样式

## 4. 核心算法与业务逻辑

### 4.1 时间段冲突检测算法

**实现位置**: `src/main/java/com/badminton/model/TimeSlot.java`

**算法原理**:
两个时间段重叠的条件是：它们不满足"完全不重叠"的条件。

完全不重叠的条件：
- 时间段A完全在时间段B之前：`A.end <= B.start`
- 时间段A完全在时间段B之后：`B.end <= A.start`

因此，重叠条件为：`!(A.end <= B.start || B.end <= A.start)`

**代码实现**:
```java
public boolean overlaps(TimeSlot other) {
    if (other == null) return false;
    return !(this.end.isBefore(other.start) || other.end.isBefore(this.start));
}
```

### 4.2 费用计算策略

**实现位置**: `src/main/java/com/badminton/util/DefaultFeePolicy.java`

**策略规则**:
- **工作日白天**（18:00之前）:
  - 单打：10元/小时
  - 双打：15元/小时
- **工作日晚间/周末**（18:00之后或周末）:
  - 单打：15元/小时
  - 双打：20元/小时

**计算逻辑**:
1. 判断是否为周末（`DayOfWeek.SATURDAY` 或 `DayOfWeek.SUNDAY`）
2. 判断开始时间是否在18:00之前
3. 计算时间段总分钟数
4. 根据规则计算费用（按分钟精确计算）

### 4.3 JSON解析算法

**实现位置**: `src/main/java/com/badminton/persistence/JsonDB.java`

**大括号匹配算法**（第474-484行）:
```java
private int findMatchingBrace(String str, int start) {
    int count = 0;
    for (int i = start; i < str.length(); i++) {
        if (str.charAt(i) == '{') count++;
        if (str.charAt(i) == '}') {
            count--;
            if (count == 0) return i;
        }
    }
    return -1;
}
```

**解析流程**:
1. 读取整个文件内容
2. 找到数组开始标记 `[`
3. 循环查找每个对象开始标记 `{`
4. 使用大括号匹配算法找到对象结束位置
5. 提取对象JSON字符串
6. 使用正则表达式解析字段值

## 5. UI设计规范

### 5.1 颜色方案
- **主色调**: 蓝色 `Color(70, 130, 180)` - 按钮、表头
- **背景色**: 浅灰 `Color(248, 249, 252)` - 主面板背景
- **表格行**: 淡蓝色 `Color(173, 216, 230)` - 可用状态
- **冲突高亮**: 淡红色 `Color(255, 200, 200)` - 不可用状态
- **文字颜色**: 白色（按钮、表头、表格行）、深灰色（输入框）

### 5.2 组件样式
- **输入框**: 圆角（6px），白色背景，聚焦时蓝色边框（2px）
- **按钮**: 圆角（8px），蓝色背景，白色文字，无边框
- **表格**: 淡蓝色背景，白色文字，无悬停效果
- **表头**: 蓝色背景，白色文字，始终一致

### 5.3 布局规范
- 使用 `GridBagLayout` 精确控制组件位置
- 使用 `JSplitPane` 分割表格和表单区域
- 使用 `CardLayout` 管理面板切换
- 统一使用 `BorderFactory` 创建边框和间距

## 6. 数据持久化设计

### 6.1 存储结构
数据存储在 `data/` 目录下，每个实体类型对应一个JSON文件：

```
data/
├── students.json    # 学生数据数组
├── admins.json      # 管理员数据数组
├── courts.json      # 场地数据数组
└── bookings.json    # 预约数据数组（包含嵌套的Student和TimeSlot对象）
```

### 6.2 JSON格式示例

**students.json**:
```json
[
  {
    "studentId": "S001",
    "name": "张三",
    "phone": "13800000001"
  }
]
```

**bookings.json**:
```json
[
  {
    "bookingId": "BK12345678",
    "student": {
      "studentId": "S001",
      "name": "张三",
      "phone": "13800000001"
    },
    "courtId": "C001",
    "slot": {
      "date": "2024-01-15",
      "start": "14:00",
      "end": "16:00"
    },
    "state": "PENDING",
    "fee": 20.0,
    "rating": 0,
    "createdAt": "2024-01-15T10:30:00"
  }
]
```

### 6.3 持久化策略
- **写入时机**: 每次数据变更后立即保存（`addStudent`、`addBooking`等方法内部调用`saveToFile()`）
- **读取时机**: 程序启动时通过 `JsonDB.loadFromFile()` 加载
- **编码格式**: UTF-8
- **错误处理**: 捕获 `IOException`，打印错误信息但不中断程序

## 7. 异常处理

### 7.1 业务异常
**实现位置**: `src/main/java/com/badminton/util/BusinessException.java`

**使用场景**:
- 学生不存在
- 场地不存在或维护中
- 预约冲突
- 权限不足
- 状态不允许操作

### 7.2 输入验证
- **时间格式验证**: 必须为 `HH:00` 格式（整点）
- **日期格式验证**: 必须为 `yyyy-MM-dd` 格式
- **中英文冒号兼容**: 自动转换中文冒号为英文冒号
- **学号唯一性**: 注册时检查
- **手机号格式**: 基本格式验证

## 8. 测试建议

### 8.1 功能测试
1. **学生注册登录**: 测试学号唯一性、重复注册处理
2. **预约功能**: 测试正常预约、冲突检测、维护中场地
3. **取消预约**: 测试权限检查、状态检查
4. **时间输入**: 测试中英文冒号兼容性、整点验证
5. **冲突高亮**: 测试实时冲突检测和UI高亮
6. **数据持久化**: 测试重启后数据加载

### 8.2 边界测试
1. **时间边界**: 测试跨天、跨周、跨月的时间段
2. **费用计算**: 测试跨白天/晚间、跨工作日/周末
3. **JSON解析**: 测试空文件、损坏文件、特殊字符

### 8.3 UI测试
1. **响应式布局**: 测试窗口大小变化
2. **表格显示**: 测试大量数据时的滚动
3. **输入验证**: 测试错误输入的提示信息

## 9. 扩展功能建议

### 9.1 功能扩展
- 预约撤销时间限制（如距开始1小时前可取消）
- 预约提醒功能（邮件/短信）
- 场地图片展示
- 预约历史记录导出（CSV/PDF）
- 多语言支持

### 9.2 技术扩展
- 数据库支持（SQLite/MySQL）替代JSON文件
- REST API + Web前端
- 移动端应用
- 实时通知系统（WebSocket）
- 数据备份和恢复功能

## 10. 部署说明

### 10.1 编译
使用项目根目录下的 `compile.bat`（Windows）或 `compile.sh`（Linux/Mac）编译项目。

### 10.2 运行
- **Swing界面**: 运行 `run-swing.bat` 或 `run-swing.sh`
- **控制台界面**: 运行 `run-console.bat` 或 `run-console.sh`

### 10.3 数据目录
首次运行会自动创建 `data/` 目录和默认数据文件。

### 10.4 默认账户
- **管理员**: 工号 `admin`，密码 `admin123`
- **默认场地**: C001-C008（4个单打场地，4个双打场地）

## 11. 项目总结

### 11.1 技术亮点
1. **无外部依赖**: 使用纯Java实现JSON解析，无需Gson等库
2. **实时反馈**: 输入时实时检测冲突并高亮显示
3. **用户体验**: 支持中英文冒号，友好的错误提示
4. **代码组织**: 清晰的分层架构，职责分离

### 11.2 设计模式应用
- **服务层模式**: Service类封装业务逻辑
- **策略模式**: FeePolicy接口实现费用计算策略
- **MVC模式**: Model-View-Controller分离

### 11.3 可维护性
- 代码结构清晰，包组织合理
- 方法职责单一，易于测试
- 异常处理完善
- 注释充分，易于理解

---

**文档版本**: 1.0  
**最后更新**: 2024年  
**作者**: 项目开发团队

